---
title: 'Everyday DS'
date: 2024-12-01 21:37:52
tags: []
published: true
hideInList: false
feature: 
isTop: false
---
每日 #数据结构。

### 241201

[P11364](https://www.luogu.com.cn/problem/P11364)。[[noip2024-you-ji|noip2024 T4]]。

考虑一个节点 $u$，和 $u$ 的叶子 $v$ 合并，贡献是若干个连续段对 $[l1,r1]$ 到 $[r1+1,r2]$ 的答案为 $dep_u$。由于 $[l1,r1]$ 内任选两点一定在 $u$ 子树中的某个点被贡献过，所以可以当成 $[l1,r2]$ 有 $dep_u$ 的贡献。对每个 $u$ 维护子树内连续段，启发式合并。因为每个贡献区间都是两个连续段合并起来，所以只有 $n-1$ 个长度 $>1$ 的区间和 $n$ 个单点。

单点可以用 st 表维护区间最大值，对 $k=1$ 的询问贡献。对于有贡献的区间和询问区间，分三类考虑。有贡献的区间左端点小于询问区间左端点，按 $l$ 从小到大扫描线，贡献加在 $r$ 上，查询 $l\le ql,r\in [ql+qk-1,qr]$ 的答案。有贡献的区间右端点大于询问区间右端点同理。否则 $ql\le l\le r\le qr$，按 $r-l+1$ 从大到小扫描线，贡献加在 $l$ 上，查询 $k\ge qk,l\in [ql,qr-qk+1]$ 的答案。

优化启发式合并，只要对每个 $i$ 二分在 $lca(i,i+1)$ 的子树内包含 $i$ 的极长连通块，st 表求区间 dfn 最大最小的点，$O(n\log n)-O(1)$ lca。